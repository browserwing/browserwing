# AI Agent 聊天功能 - 快速开始

## 功能概述

BrowserPilot 现在集成了强大的 AI Agent 聊天功能,可以通过自然语言对话来控制浏览器自动化脚本!

### 主要特性

- 🤖 **智能对话**: 使用 OpenAI GPT-4 或 Anthropic Claude 进行自然语言交互
- 🔧 **MCP 工具集成**: 自动将录制的脚本作为工具提供给 AI
- ⚡ **流式响应**: 打字机效果的实时消息显示
- 🔄 **自动更新**: 新增的 MCP 命令会在 5 秒内自动被识别
- 📊 **状态可视化**: 实时显示工具调用状态
- 💬 **多会话管理**: 支持创建和管理多个独立聊天会话

## 使用步骤

### 步骤 1: 配置 LLM

1. 访问 "大模型" 页面 (`/llm`)
2. 点击 "添加配置"
3. 填写配置信息:
   ```
   名称: My OpenAI
   提供商: openai
   模型: gpt-4
   API Key: sk-xxx...
   Base URL: https://api.openai.com/v1 (可选)
   ```
4. 保存配置

**支持的提供商:**
- OpenAI (gpt-4, gpt-4-turbo, gpt-3.5-turbo等)
- Anthropic (claude-3-opus, claude-3-sonnet等)

### 步骤 2: 创建 MCP 脚本

1. 访问 "浏览器" 页面
2. 启动浏览器
3. 点击 "开始录制"
4. 在浏览器中执行你想自动化的操作
5. 点击 "停止录制"
6. 保存脚本并给它一个名字

### 步骤 3: 将脚本设置为 MCP 命令

1. 访问 "脚本管理" 页面
2. 找到你刚录制的脚本
3. 点击脚本操作栏的 MCP 按钮 (紫色图标)
4. 在弹出的对话框中配置:
   - **MCP 命令名称**: 例如 `login_website` (使用小写字母和下划线)
   - **MCP 命令描述**: 描述这个脚本的功能,例如 "自动登录网站"
   - **(可选) 输入参数定义**: 如果脚本需要参数,定义 JSON Schema
5. 点击保存

**参数定义示例:**
```json
{
  "type": "object",
  "properties": {
    "username": {
      "type": "string",
      "description": "登录用户名"
    },
    "password": {
      "type": "string",
      "description": "登录密码"
    }
  },
  "required": ["username", "password"]
}
```

### 步骤 4: 开始使用 AI 聊天

1. 访问 "AI 聊天" 页面 (`/agent`)
2. 点击 "新会话" 创建一个新的聊天
3. 在输入框中输入你的请求,例如:
   - "帮我登录这个网站,用户名是 test@example.com,密码是 123456"
   - "打开百度并搜索 '今天天气'"
   - "执行我的自动化脚本"
4. AI 会自动理解你的意图并调用相应的 MCP 工具

## 界面说明

### 聊天界面

```
┌─────────────────────────────────────────────────────────┐
│ AI Agent                       [MCP: 3 工具] [新会话]   │
├────────────┬────────────────────────────────────────────┤
│            │                                            │
│  会话列表  │           消息区域                         │
│            │                                            │
│ • 新会话   │  [User]  你好,帮我...                     │
│ • 会话 2   │  [AI]    好的,我来帮你...                 │
│ • 会话 3   │  [Tool]  ⚙️ 正在调用: login_website      │
│            │  [Tool]  ✅ 工具调用成功                  │
│            │  [AI]    已完成登录                       │
│            │                                            │
├────────────┴────────────────────────────────────────────┤
│  [输入消息...] [Shift+Enter 换行]              [发送]   │
└─────────────────────────────────────────────────────────┘
```

### 消息类型

- **用户消息**: 白色气泡,显示在右侧
- **AI 消息**: 深灰色气泡,显示在左侧
- **工具调用**: 紫色图标,显示工具名称和状态
  - 🔵 正在调用...
  - ✅ 调用成功
  - ❌ 调用失败

## 示例对话

### 示例 1: 简单任务

```
用户: 帮我打开百度
AI: 好的,我现在为你打开百度。
    [⚙️ 正在调用: open_baidu]
    [✅ 工具调用成功]
    已成功打开百度首页。
```

### 示例 2: 带参数的任务

```
用户: 帮我登录网站,用户名是 user@test.com,密码是 pass123
AI: 我来帮你登录。
    [⚙️ 正在调用: login_website]
    [✅ 工具调用成功]
    登录成功!已使用用户名 user@test.com 完成登录。
```

### 示例 3: 复杂任务

```
用户: 搜索最新的人工智能新闻并保存前3条标题
AI: 好的,我会为你完成这个任务。
    [⚙️ 正在调用: search_news]
    [✅ 工具调用成功]
    [⚙️ 正在调用: extract_headlines]
    [✅ 工具调用成功]
    已完成!找到并保存了以下 3 条最新 AI 新闻标题:
    1. GPT-5 即将发布...
    2. AI 在医疗领域的突破...
    3. 自动驾驶技术新进展...
```

## 技术细节

### MCP 工具自动发现

Agent 系统会:
1. 启动时加载所有已设置为 MCP 命令的脚本
2. 每 5 秒自动检查是否有新的 MCP 命令添加
3. 动态更新所有活跃会话的工具列表

### 流式响应

- 使用 Server-Sent Events (SSE) 技术
- 消息逐字显示,模拟打字机效果
- 每个字之间间隔 30 毫秒
- 提供流畅的用户体验

### 工具调用流程

```
用户输入 → AI 理解意图 → 选择工具 → 调用 MCP 脚本 → 获取结果 → 回复用户
```

## 常见问题

### Q: 如何让 AI 能调用我的脚本?

A: 需要将脚本设置为 MCP 命令。在脚本管理页面点击脚本的 MCP 按钮进行配置。

### Q: AI 为什么没有调用工具?

A: 可能的原因:
1. 脚本未设置为 MCP 命令
2. 命令描述不够清晰,AI 无法理解
3. LLM 未正确配置
4. 等待 5 秒让系统发现新工具

### Q: 如何自定义 AI 的行为?

A: 目前可以通过:
1. 选择不同的 LLM 模型 (GPT-4 更智能)
2. 编写清晰的 MCP 命令描述
3. 在对话中给出明确的指令

### Q: 支持多模态吗?

A: 当前版本仅支持文本对话。图片、文件等多模态功能计划在未来版本中添加。

### Q: 会话数据会被保存吗?

A: 目前会话数据保存在内存中,重启后会丢失。持久化功能将在未来版本中添加。

## 最佳实践

### 1. 清晰的命令描述

❌ **不好的描述**: "脚本1"  
✅ **好的描述**: "自动登录 Gmail 并检查未读邮件数量"

### 2. 合理的命令命名

❌ **不好的命名**: `script1`, `test`, `my_script`  
✅ **好的命名**: `login_gmail`, `search_google`, `extract_product_info`

### 3. 详细的参数说明

在 JSON Schema 中为每个参数添加清晰的 `description`:

```json
{
  "type": "object",
  "properties": {
    "query": {
      "type": "string",
      "description": "要搜索的关键词,例如: 人工智能"
    },
    "max_results": {
      "type": "integer",
      "description": "返回的最大结果数量,默认为 10"
    }
  }
}
```

### 4. 分解复杂任务

将复杂的自动化流程分解为多个独立的 MCP 命令,让 AI 可以灵活组合使用。

例如,不要创建一个 "搜索并保存结果" 的大脚本,而是分为:
- `search_keyword`: 搜索关键词
- `extract_results`: 提取搜索结果
- `save_to_file`: 保存到文件

## 故障排查

### 问题: MCP 状态显示 0 工具

**解决方法:**
1. 检查是否有脚本被设置为 MCP 命令
2. 等待 5 秒让系统自动发现
3. 刷新页面

### 问题: 发送消息后没有响应

**解决方法:**
1. 检查 LLM 配置是否正确
2. 检查 API Key 是否有效
3. 查看浏览器控制台的错误信息
4. 检查后端日志

### 问题: AI 一直在调用错误的工具

**解决方法:**
1. 改进 MCP 命令的描述,使其更准确
2. 在对话中明确指定要使用的工具
3. 考虑使用更强大的 LLM 模型 (如 GPT-4)

## 技术支持

遇到问题?
1. 查看后端日志: `logs/browserwing.log`
2. 检查浏览器控制台
3. 参考文档: `docs/MCP_INTEGRATION.md`

---

**享受与 AI 一起自动化的乐趣吧!** 🚀
